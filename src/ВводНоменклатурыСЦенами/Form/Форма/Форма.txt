
&НаСервере
Функция СоздатьНаСервере()
	
	Артикул = ПолучитьАртикул();
	Номенклатура = СоздатьНаСервереНоменклатуру(Артикул);
	Приход = СоздатьПТУС(Номенклатура);
	
	
	НаименованиеТипаЦен = НСтр("ru='Розничная цена'");
	ВидЦены = Справочники.ВидыЦен.НайтиПоНаименованию(НаименованиеТипаЦен);
	ВидЦены = Справочники.ВидыЦен.ВидЦеныПоУмолчанию(ВидЦены);
	УстановкаЦены = Документы.УстановкаЦенНоменклатуры.СоздатьДокумент();
	УстановкаЦены.Заполнить(Приход.Ссылка);
	УстановкаЦены.Дата = ТекущаяДата();
	
	Товар = УстановкаЦены.Товары.Получить(0);
	Товар.ВидЦены = ВидЦены;
	Товар.ЦенаИзмененаВручную = Истина;
	Товар.Цена = Объект.РозничнаяЦена;
	УстановкаЦены.Согласован = Истина;
	
	УстановкаЦены.Записать(РежимЗаписиДокумента.Проведение);
	Сообщение1 = Новый СообщениеПользователю;
	Сообщение1.Текст = "3. Создан Установка цен ["+Строка(УстановкаЦены)+"]";
	Сообщение1.Сообщить();
	
	Товары = Обработки.ПечатьЭтикетокИЦенников.Создать().Товары;
	НоваяСтрока = Товары.Добавить();
	НоваяСтрока.Номенклатура = Номенклатура.ссылка;
	НоваяСтрока.КоличествоЭтикеток = Объект.Количество;
	НоваяСтрока.ШаблонЭтикетки = Номенклатура.ШаблонЭтикетки;
	НоваяСтрока.ШаблонЦенника = Номенклатура.ШаблонЦенника;
	НоваяСтрока.Штрихкод = Артикул;
	
	Адрес = ПоместитьВоВременноеХранилище(Товары.Выгрузить());
	
	Организация               = ЗначениеНастроекПовтИсп.ПолучитьОрганизациюПоУмолчанию(Организация);
	
	
	СтруктураПараметры = Новый Структура("Товары, ВидЦены, Дата, Организация, Коллекция, ПравилоОбмена, МаксимальныйКодВесовогоТовара, ПравилоВыгрузкиВВесы,  ВидЦеныДополнительно, ДатаДополнительно ", Адрес, ВидЦены, ТекущаяДата(),Организация );
	
	
	Коллекция = УправлениеПечатью.ПодготовитьКоллекциюПечатныхФорм( "ЭтикеткаТовары");
	
	Обработки.ПечатьЭтикетокИЦенников.Печать( Новый Массив, СтруктураПараметры , Коллекция, Неопределено , Неопределено);
	
	СтруктураПараметры.Коллекция = Коллекция;
	
	Возврат  СтруктураПараметры;	
	
	// Вставить содержимое обработчика.
КонецФункции

&НаКлиенте
Процедура Создать(Команда)
	
	СтруктураПараметры = СоздатьНаСервере();
	 Для Каждого ПечатнаяФорма Из СтруктураПараметры.Коллекция Цикл
	 ПечатнаяФорма.ТабличныйДокумент.Напечатать(РежимИспользованияДиалогаПечати.Использовать); 
	 КонецЦикла;
КонецПроцедуры




&НаКлиенте
Процедура ОткрытьФормуОбработки(СтруктураПараметры) Экспорт
	
	ОткрытьФорму("Обработка.ПечатьЭтикетокИЦенников.Форма.ФормаТовары",
	СтруктураПараметры,            // Параметры
	
	,                              // Владелец
	
	Новый УникальныйИдентификатор  // Уникальность
	
	);
	
КонецПроцедуры


&НаСервере
Функция ПолучитьАртикул()
	
	Перем Артикул, ВыборкаДетальныеЗаписи, Запрос, РезультатЗапроса;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	Номенклатура.Артикул КАК Артикул
	|ИЗ
	|	Справочник.Номенклатура КАК Номенклатура
	|ГДЕ
	|	Номенклатура.Артикул ПОДОБНО ""[0-9][0-9][0-9][0-9][0-9][0-9][0-9]""
	|
	|УПОРЯДОЧИТЬ ПО
	|	Артикул УБЫВ";
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	Артикул = 0;
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		Артикул = Число(ВыборкаДетальныеЗаписи.Артикул);
	КонецЦикла;
	Возврат Артикул;
	
КонецФункции

&НаСервере
Функция СоздатьПТУС(Знач Номенклатура)
	
	Перем ВыборВидаЦены, Приход, Сообщение1, Товар, Товары;
	
	Приход = Документы.ПоступлениеТоваровУслуг.СоздатьДокумент();
	//ЭлементыОтбора = Новый Структура("Поставщик", Объект.Поставщик, СсылкаНаСклад);
	Приход.Заполнить(Объект.Поставщик);
	Приход.Партнер = Объект.Поставщик;
	Приход.ЗаполнитьУсловияЗакупокПоУмолчанию(Ложь);
	Товары = Приход.Товары;
	Товар = Товары.Добавить();
	ВыборВидаЦены = Справочники.ВидыЦенПоставщиков.Выбрать(,Объект.Поставщик);
	ВыборВидаЦены.Следующий();
	Товар.Номенклатура = Номенклатура.Ссылка;
	Товар.ВидЦеныПоставщика = ВыборВидаЦены.Ссылка;
	Товар.Цена = Объект.ЗакупочнаяЦена;
	Товар.Количество = Объект.Количество;
	Товар.КоличествоУпаковок = Товар.Количество;
	Товар.Сумма = Товар.Цена * Товар.Количество;
	Товар.СтавкаНДС = Перечисления.СтавкиНДС.БезНДС;
	Товар.СуммаСНДС = Товар.Сумма;
	
	Товар.Склад = Приход.Склад;
	Приход.Записать(РежимЗаписиДокумента.Проведение);
	Сообщение1 = Новый СообщениеПользователю;
	Сообщение1.Текст = "2. Создан ПоступлениеТоваровУслуг ["+Строка(Приход)+"]";
	Сообщение1.Сообщить();
	Возврат Приход;
	
КонецФункции

&НаСервере
Функция СоздатьНаСервереНоменклатуру(Знач Артикул)
	
	Перем Номенклатура, РС, Сообщение1;
	
	Номенклатура = Справочники.Номенклатура.НайтиПоНаименованию(Объект.Наименование);
	Если Номенклатура = Неопределено или Номенклатура.Пустая() Тогда
		Номенклатура = Справочники.Номенклатура.СоздатьЭлемент();
		Номенклатура.Артикул = Формат(Артикул+1,"ЧЦ=7; ЧДЦ=; ЧН=; ЧВН=; ЧГ=0");
		Номенклатура.ВидНоменклатуры = Объект.ВидНоменклатуры;
		Номенклатура.Наименование = Объект.Наименование;
		Номенклатура.НаименованиеПолное = Номенклатура.Наименование;
		//Номенклатура.ЕдиницаИзмерения = Справочники.УпаковкиЕдиницыИзмерения.НайтиПоКоду(
		Справочники.ВидыНоменклатуры.ПолучитьПредустановленныеВидыНоменклатуры();
		Справочники.Номенклатура.ЗаполнитьРеквизитыПоВидуНоменклатуры(Номенклатура);
		Номенклатура.Записать();
		
		РС = РегистрыСведений.ШтрихкодыНоменклатуры.СоздатьМенеджерЗаписи();
		РС.Штрихкод = Номенклатура.Артикул;
		РС.Номенклатура = Номенклатура.Ссылка;
		РС.Записать(Истина);
		Сообщение1 = новый СообщениеПользователю;
		Сообщение1.Текст = "1. Создана номенклатура ["+Строка(Номенклатура)+"]";
		Сообщение1.Сообщить();
	КонецЕсли;
	Возврат Номенклатура;
КонецФункции



&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	Объект.Количество = 1;
КонецПроцедуры


