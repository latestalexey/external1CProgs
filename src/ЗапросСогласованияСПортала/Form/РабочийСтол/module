Перем ТаблицаВладельцевУслуг;


Процедура КнопкаВыполнитьНажатие(Кнопка)
	// Вставить содержимое обработчика.
КонецПроцедуры

Процедура КоманднаяПанель1Обновить(Кнопка)
	ВременныйФайл = ПолучитьИмяВременногоФайла(".xlsx");
	//КопироватьФайл("http://msmr/docs/it/services/_layouts/bcs/ExportToExcel.aspx?entitynamespace=SollersDV.ITIL.SharePoint.Bcs&entityname=ProvisionedService&findermethodname=GetServiceListForExport&worksheetname=ITServices&filename=Services",ВременныйФайл);
	ТаблицаВладельцевУслуг = ОбработкаОбъект
	//msmr.fe.severstalauto.com/docs/it/services/_layouts/bcs/ExportToExcel.aspx?entitynamespace=SollersDV.ITIL.SharePoint.Bcs&entityname=ProvisionedService&findermethodname=GetServiceListForExport&worksheetname=ITServices
	.Создать(ВременныйФайл)
	//.СкачатьВФайлИз("10.19.88.25","/docs/it/services/_layouts/bcs/ExportToExcel.aspx")  "msmr.fe.severstalauto.com"
	.СкачатьВФайлИз("msmr","docs/it/services/_layouts/bcs/ExportToExcel.aspx?entitynamespace=SollersDV.ITIL.SharePoint.Bcs&entityname=ProvisionedService&findermethodname=GetServiceListForExport&worksheetname=ITServices")
	.ПрочитатьФайлЭксельВТаблицуЗначений(ВременныйФайл, "Услуга,	Владелец,	ОсновнойПериодПоддержки,	СогласованиеВладельцем, СогласованиеРуководителем,	ТипСогласования,	Согласующие, 	Категория,	Провайдер,	ОсобыеУслуги,	Id" );
	ОбработкаОбъект.УдалитьВременныйФайл(); 

		//{{КОНСТРУКТОР_ЗАПРОСА_С_ОБРАБОТКОЙ_РЕЗУЛЬТАТА
	// Данный фрагмент построен конструктором.
	// При повторном использовании конструктора, внесенные вручную изменения будут утеряны!!!

	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ВЫРАЗИТЬ(ТаблицаУслуг.Провайдер КАК СТРОКА(100)) КАК Провайдер
		|ПОМЕСТИТЬ Провайдеры
		|ИЗ
		|	&ТаблицаУслуг КАК ТаблицаУслуг
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ИСТИНА КАК Пометка,
		|	Провайдеры.Провайдер,
		|	&ТекущаяДата КАК Начало
		|ИЗ
		|	Провайдеры КАК Провайдеры";

	Запрос.УстановитьПараметр("ТекущаяДата", ТекущаяДата());
	Запрос.УстановитьПараметр("ТаблицаУслуг", ТаблицаВладельцевУслуг);

	ТаблицаВыбораПровайдеров = Запрос.Выполнить().Выгрузить();


	
КонецПроцедуры

Процедура КоманднаяПанель1Далее(Кнопка)
	ЭтаФорма.Панель.ТекущаяСтраница = ЭтаФорма.Панель.Страницы.Страница2;
КонецПроцедуры

Процедура Кнопка1Нажатие(Элемент)
	
	 	//{{КОНСТРУКТОР_ЗАПРОСА_С_ОБРАБОТКОЙ_РЕЗУЛЬТАТА
	// Данный фрагмент построен конструктором.
	// При повторном использовании конструктора, внесенные вручную изменения будут утеряны!!!

	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ТаблицаПровайдеров.Пометка,
		|	ВЫРАЗИТЬ(ТаблицаПровайдеров.Провайдер КАК СТРОКА(100)) КАК Провайдер,
		|	ТаблицаПровайдеров.Начало
		|ПОМЕСТИТЬ Провайдеры
		|ИЗ
		|	&ТаблицаПровайдеров КАК ТаблицаПровайдеров
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ТаблицаВладельцев.Услуга,
		|	ТаблицаВладельцев.Владелец,
		|	ТаблицаВладельцев.ОсновнойПериодПоддержки,
		|	ТаблицаВладельцев.СогласованиеВладельцем,
		|	ТаблицаВладельцев.СогласованиеРуководителем,
		|	ТаблицаВладельцев.ТипСогласования,
		|	ТаблицаВладельцев.Согласующие,
		|	ТаблицаВладельцев.Категория,
		|	ВЫРАЗИТЬ(ТаблицаВладельцев.Провайдер КАК СТРОКА(100)) КАК Провайдер,
		|	ТаблицаВладельцев.ОсобыеУслуги
		|ПОМЕСТИТЬ ТаблицаВладельцев
		|ИЗ
		|	&ТаблицаВладельцев КАК ТаблицаВладельцев
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Провайдеры.Провайдер КАК Провайдер,
		|	Провайдеры.Начало КАК Начало,
		|	ТаблицаВладельцев.Владелец
		|ИЗ
		|	Провайдеры КАК Провайдеры
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблицаВладельцев КАК ТаблицаВладельцев
		|		ПО (Провайдеры.Пометка)
		|			И Провайдеры.Провайдер = ТаблицаВладельцев.Провайдер
		|			И (ТаблицаВладельцев.Услуга ПОДОБНО ""%(1С:УПП)%""
		|				ИЛИ ТаблицаВладельцев.Услуга ПОДОБНО ""%(1С: УПП)%"")
		|ИТОГИ
		|	МАКСИМУМ(Начало)
		|ПО
		|	Провайдер";
   	Запрос.УстановитьПараметр("ТаблицаВладельцев", ТаблицаВладельцевУслуг);
   	Запрос.УстановитьПараметр("ТаблицаПровайдеров", ТаблицаВыбораПровайдеров);

	Результат = Запрос.Выполнить();


	ВыборкаПровайдер = Результат.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);

	Пока ВыборкаПровайдер.Следующий() Цикл
		Выборка = ВыборкаПровайдер.Выбрать();
		Адрес = "";
		Пока Выборка.Следующий() Цикл
             Адрес = Адрес+ Выборка.Владелец;
		КонецЦикла;
		
		     Тема = "Тема письма";
             ТекстПисьма = "Текст письма";
             СтрокаЗапуска = "mailto:" + Адрес + "?subject=" + Тема + "&body=" + ТекстПисьма;
             ЗапуститьПриложение(СтрокаЗапуска);
		
	КонецЦикла;
	КонецПроцедуры
